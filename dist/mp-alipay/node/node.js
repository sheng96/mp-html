"use strict";function t(e){"@babel/helpers - typeof";return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,e,o){return e=r(e),e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}function r(e){var r=o(e,"string");return"symbol"==t(r)?r:String(r)}function o(e,r){if("object"!=t(e)||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var i=o.call(e,r||"default");if("object"!=t(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(e)}function i(t){var e;return e=e=t.detail.pageY,(e-t.currentTarget.offsetTop<150||e<600)&&(e=t.currentTarget.offsetTop),e<30&&(e+=70),e-30}var s=require("../parser");Component({data:{ctrl:{}},props:{childs:[],opts:[]},options:{addGlobalClass:!0},didMount:function(){this.props.onAdd(this)},didUnmount:function(){this.root&&this.root._edit===this&&(this.root._edit=void 0)},methods:{editStart:function(t){var r=this;if(this.props.opts[5]){var o=t.currentTarget.dataset.i;this.data.ctrl["e"+o]?(this.root._mask.pop(),this.root._maskTap(),this.setData(e({},"ctrl.e"+o,2)),setTimeout(function(){r.setData(e({},"ctrl.e"+o,3))},50)):(this.setData(e({},"ctrl.e"+o,1)),setTimeout(function(){r.root._mask.push(function(){r.setData(e({},"ctrl.e"+o,0))})},50),this.root._edit=this,this.i=o,this.cursor=this.getNode(o).text.length)}},editInput:function(t){var e=t.target.dataset.i,r=t.detail.value.replace(/ {2,}/,function(t){for(var e=" ",r=1;r<t.length;r++)e+=" ";return e});this.root._editVal("nodes["+(this.props.opts[7]+e).replace(/_/g,"].children[")+"].text",this.getNode(e).text,r),this.cursor=t.detail.cursor},editEnd:function(t){var r=t.target.dataset.i;this.setData(e({},"ctrl.e"+r,0)),this.root.setData(e({},"nodes["+(this.props.opts[7]+r).replace(/_/g,"].children[")+"].text",t.detail.value.replace(/ {2}/g,"  "))),void 0!==t.detail.cursor&&(this.cursor=t.detail.cursor)},insert:function(t){var e=this;setTimeout(function(){var r=e.i.split("_"),o=parseInt(r.pop()),i=r.join("_"),s=i?e.getNode(i).children:e.props.childs,a=s.slice(0);if(a[o])if(a[o].text){var n=a[o].text;if("text"===t.type)e.cursor?a[o].text=n.substring(0,e.cursor)+t.text+n.substring(e.cursor):a[o].text+=t.text;else{var c=[];e.cursor&&c.push({type:"text",text:n.substring(0,e.cursor)}),c.push(t),e.cursor<n.length&&c.push({type:"text",text:n.substring(e.cursor)}),a.splice.apply(a,[o,1].concat(c))}}else a.splice(o+1,0,t);else a.push(t);i=e.props.opts[7]+i,"_"===i[i.length-1]&&(i=i.slice(0,-1)),e.root._editVal("nodes"+(i?"["+i.replace(/_/g,"].children[")+"].children":""),s,a,!0),e.i=r.join("_")+"_"+(o+1)},200)},remove:function(t){var e=t.split("_"),r=e.pop(),o=e.join("_"),i=o?this.getNode(o).children:this.props.childs,s=i.slice(0),a=s.splice(r,1)[0];if("img"===a.name||"video"===a.name||"audio"===a.name){var n=a.attrs.src;a.src&&(n=1===a.src.length?a.src[0]:a.src),this.root.props.onRemove&&this.root.props.onRemove({type:a.name,src:n})}this.root._edit=void 0,this.root._maskTap(),o=this.props.opts[7]+o,"_"===o[o.length-1]&&(o=o.slice(0,-1)),this.root._editVal("nodes"+(o?"["+o.replace(/_/g,"].children[")+"].children":""),i,s,!0)},nodeTap:function(t){var r=this;if(this.props.opts[5]){if(this.root._lock)return;this.root._lock=!0,setTimeout(function(){r.root._lock=!1},50);var o=t.currentTarget.dataset.i,s=this.getNode(o);if(3===this.data.ctrl["e"+this.i])return;this.root._maskTap(),this.root._edit=this;var a=o.split("_"),n=parseInt(a.pop()),c=a.join("_"),l=c?this.getNode(c).children:this.props.childs;if(this.setData(e({},"ctrl.e"+o,1)),this.root._mask.push(function(){r.setData(e({},"ctrl.e"+o,0))}),1===s.children.length&&"text"===s.children[0].type){var h=o+"_0";this.data.ctrl["e"+h]||(this.setData(e({},"ctrl.e"+h,1)),this.root._mask.push(function(){r.setData(e({},"ctrl.e"+h,0))}),this.cursor=s.children[0].text.length),this.i=h}else(this.i||"").includes(o)||(this.i=o+"_");var p=this.root._getItem(s,0!==n,n!==l.length-1);this.root._tooltip({top:i(t),items:p,success:function(e){if("大小"===p[e]){var a=s.attrs.style||"",h=a.match(/;font-size:([0-9]+)px/);h=h?parseInt(h[1]):16,r.root._slider({min:10,max:30,value:h,top:i(t),changing:function(e){Math.abs(e-h)>2&&(r.changeStyle("font-size",o,e+"px",h+"px"),h=t.detail.value)},change:function(t){t!==h&&r.changeStyle("font-size",o,t+"px",h+"px"),r.root._editVal("nodes["+(r.props.opts[7]+o).replace(/_/g,"].children[")+"].attrs.style",a,r.getNode(o).attrs.style)}})}else if("颜色"===p[e]){var d=r.root._getItem("color");r.root._color({top:i(t),items:d,success:function(t){var e=s.attrs.style||"",i=e.match(/;color:([^;]+)/);r.changeStyle("color",o,d[t],i?i[1]:void 0),r.root._editVal("nodes["+(r.props.opts[7]+o).replace(/_/g,"].children[")+"].attrs.style",e,r.getNode(o).attrs.style)}})}else if("上移"===p[e]||"下移"===p[e]){var u=l.slice(0),g=u[n];"上移"===p[e]?(u[n]=u[n-1],u[n-1]=g):(u[n]=u[n+1],u[n+1]=g),c=r.props.opts[7]+c,"_"===c[c.length-1]&&(c=c.slice(0,-1)),r.root._editVal("nodes"+(c?"["+c.replace(/_/g,"].children[")+"].children":""),l,u,!0)}else if("删除"===p[e])r.remove(o);else{var f,_,m=s.attrs.style||"",v="",y=p[e];"斜体"===y?(f="font-style",_="italic"):"粗体"===y?(f="font-weight",_="bold"):"下划线"===y?(f="text-decoration",_="underline"):"居中"===y?(f="text-align",_="center"):"缩进"===y&&(f="text-indent",_="2em"),v=m.includes(f+":")?m.replace(new RegExp(f+":[^;]+"),""):m+";"+f+":"+_,r.root._editVal("nodes["+(r.props.opts[7]+o).replace(/_/g,"].children[")+"].attrs.style",m,v,!0)}}})}},mediaTap:function(t){var r=this;if(this.props.opts[5]){var o=t.target.dataset.i,i=this.getNode(o),s=this.root._getItem(i);this.root._maskTap(),this.root._edit=this,this.i=o,this.root._tooltip({top:t.target.offsetTop-30,items:s,success:function(t){switch(s[t]){case"封面":r.root.getSrc("img",i.attrs.poster||"").then(function(t){r.root._editVal("nodes["+(r.props.opts[7]+o).replace(/_/g,"].children[")+"].attrs.poster",i.attrs.poster,t instanceof Array?t[0]:t,!0)}).catch(function(){});break;case"删除":r.remove(o);break;case"循环":case"不循环":r.root.setData(e({},"nodes["+(r.props.opts[7]+o).replace(/_/g,"].children[")+"].attrs.loop",!i.attrs.loop)),my.showToast({content:"成功"});break;case"自动播放":case"不自动播放":r.root.setData(e({},"nodes["+(r.props.opts[7]+o).replace(/_/g,"].children[")+"].attrs.autoplay",!i.attrs.autoplay)),my.showToast({content:"成功"})}}}),this.root._lock=!0,setTimeout(function(){r.root._lock=!1},50)}},changeStyle:function(t,r,o,i){var s=this.getNode(r).attrs.style||"";s.includes(";"+t+":"+i)?s=s.replace(";"+t+":"+i,";"+t+":"+o):s+=";"+t+":"+o,this.root.setData(e({},"nodes["+(this.props.opts[7]+r).replace(/_/g,"].children[")+"].attrs.style",s))},noop:function(){},getNode:function(t){try{for(var e=t.split("_"),r=this.props.childs[e[0]],o=1;o<e.length;o++)r=r.children[e[o]];return r}catch(t){return{text:"",attrs:{},children:[]}}},play:function(t){if(this.root.props.onPlay&&this.root.props.onPlay(),this.root.props.pauseVideo){for(var e=!1,r=t.target.id,o=this.root._videos.length;o--;)this.root._videos[o].id===r?e=!0:this.root._videos[o].pause();if(!e){var i=my.createVideoContext(r,this);i.id=r,this.root.playbackRate&&i.playbackRate(this.root.playbackRate),this.root._videos.push(i)}}},imgTap:function(t){var r=this;if(this.props.opts[5]){var o=t.target.dataset.i,a=this.getNode(o),n=this.root._getItem(a);this.root._edit=this;var c=new s(this.root);this.i=o,this.root._maskTap(),this.setData(e({},"ctrl.e"+o,1)),this.root._mask.push(function(){r.setData(e({},"ctrl.e"+o,0))}),this.root._tooltip({top:i(t),items:n,success:function(s){if("换图"===n[s])r.root.getSrc("img",a.attrs.src||"").then(function(t){r.root._editVal("nodes["+(r.props.opts[7]+o).replace(/_/g,"].children[")+"].attrs.src",a.attrs.src,c.getUrl(t instanceof Array?t[0]:t),!0)}).catch(function(){});else if("宽度"===n[s]){var l=a.attrs.style||"",h=l.match(/max-width:([0-9]+)%/);h=h?parseInt(h[1]):100,r.root._slider({min:0,max:100,value:h,top:i(t),changing:function(t){Math.abs(t-h)>5&&(r.changeStyle("max-width",o,t+"%",h+"%"),h=t)},change:function(t){t!==h&&(r.changeStyle("max-width",o,t+"%",h+"%"),h=t),r.root._editVal("nodes["+(r.props.opts[7]+o).replace(/_/g,"].children[")+"].attrs.style",l,r.getNode(o).attrs.style)}})}else"超链接"===n[s]?r.root.getSrc("link",a.a?a.a.href:"").then(function(t){if(a.a)r.root._editVal("nodes["+(r.props.opts[7]+o).replace(/_/g,"].children[")+"].a.href",a.a.href,c.getUrl(t),!0);else{var e={name:"a",attrs:{href:c.getUrl(t)},children:[a]};a.a=e.attrs,r.root._editVal("nodes["+(r.props.opts[7]+o).replace(/_/g,"].children[")+"]",a,e,!0)}my.showToast({content:"成功"})}).catch(function(){}):"预览图"===n[s]?r.root.getSrc("img",a.attrs["original-src"]||"").then(function(t){r.root._editVal("nodes["+(r.props.opts[7]+o).replace(/_/g,"].children[")+"].attrs.original-src",a.attrs["original-src"],c.getUrl(t instanceof Array?t[0]:t),!0),my.showToast({content:"成功"})}).catch(function(){}):"删除"===n[s]?r.remove(o):(r.root.setData(e({},"nodes["+(r.props.opts[7]+o).replace(/_/g,"].children[")+"].attrs.ignore",!a.attrs.ignore)),my.showToast({content:"成功"}))}}),this.root._lock=!0,setTimeout(function(){r.root._lock=!1},50)}else{var l=this.getNode(t.target.dataset.i);if(l.a)return this.linkTap(l.a);if(l.attrs.ignore)return;if(this.root.props.onImgtap&&this.root.props.onImgtap(l.attrs),this.root.props.previewImg){var h=l.i;my.previewImage({enablesavephoto:this.root.props.showImgMenu,enableShowPhotoDownload:this.root.props.showImgMenu,current:h,urls:this.root.imgList})}}},imgLoad:function(t){var r,o=t.target.dataset.i,i=this.getNode(o);if(i.w)(this.props.opts[1]&&!this.data.ctrl[o]||-1===this.data.ctrl[o])&&(r=1);else if(r=t.detail.width,this.props.opts[5]){var s={},a="nodes["+(this.props.opts[7]+o).replace(/_/g,"].children[")+"].attrs.";r<150&&(s[a+"ignore"]="T"),s[a+"width"]=r.toString(),this.root.setData(s)}r&&this.setData(e({},"ctrl."+o,r)),this.checkReady()},checkReady:function(){var t=this;this.root.props.lazyLoad||(this.root.imgList._unloadimgs-=1,this.root.imgList._unloadimgs||setTimeout(function(){t.root.getRect().then(function(e){t.root.props.onReady&&t.root.props.onReady(e)}).catch(function(){t.root.props.onReady&&t.root.props.onReady({})})},350))},linkTap:function(t){var e=this;if(this.props.opts[5]){var r=t.currentTarget.dataset.i,o=this.getNode(r),s=this.root._getItem(o);this.root._tooltip({top:i(t),items:s,success:function(t){"更换链接"===s[t]?e.root.getSrc("link",o.attrs.href).then(function(t){e.root._editVal("nodes["+(e.props.opts[7]+r).replace(/_/g,"].children[")+"].attrs.href",o.attrs.href,t,!0),my.showToast({content:"成功"})}).catch(function(){}):e.remove(r)}})}else{var a=t.currentTarget?this.getNode(t.currentTarget.dataset.i):{},n=a.attrs||t,c=n.href;this.root.props.onLinktap&&this.root.props.onLinktap(Object.assign({innerText:this.root.getText(a.children||[])},n)),c&&("#"===c[0]?this.root.navigateTo(c.substring(1)).catch(function(){}):c.split("?")[0].includes("://")?this.root.props.copyLink&&my.setClipboard({text:c,success:function(){return my.showToast({content:"链接已复制"})}}):my.navigateTo({url:c,fail:function(){my.switchTab({url:c,fail:function(){}})}}))}},mediaError:function(t){var r=t.target.dataset.i,o=this.getNode(r);if("video"===o.name||"audio"===o.name){var i=(this.data.ctrl[r]||0)+1;if(i>o.src.length&&(i=0),i<o.src.length)return this.setData(e({},"ctrl."+r,i))}else"img"===o.name&&(this.props.opts[2]&&this.setData(e({},"ctrl."+r,-1)),this.checkReady());this.root&&this.root.props.onError&&this.root.props.onError({source:o.name,attrs:o.attrs,errMsg:t.detail.errMsg})}}});